<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Repository View</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background-color: #f6f8fa;
            color: #24292f;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            background: white;
            border: 1px solid #d0d7de;
            border-radius: 6px;
            padding: 20px;
            margin-bottom: 20px;
        }

        .repo-title {
            font-size: 24px;
            font-weight: 600;
            margin-bottom: 10px;
        }

        .repo-input {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
        }

        .repo-input input {
            padding: 8px 12px;
            border: 1px solid #d0d7de;
            border-radius: 6px;
            font-size: 14px;
        }

        .repo-input button {
            background: #2da44e;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
        }

        .repo-input button:hover {
            background: #2c974b;
        }

        .main-content {
            display: grid;
            grid-template-columns: 1fr 300px;
            gap: 20px;
        }

        .file-section {
            background: white;
            border: 1px solid #d0d7de;
            border-radius: 6px;
        }

        .file-header {
            padding: 16px;
            border-bottom: 1px solid #d0d7de;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .branch-selector {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .branch-selector select {
            padding: 5px 8px;
            border: 1px solid #d0d7de;
            border-radius: 6px;
            background: white;
        }

        .action-buttons {
            display: flex;
            gap: 8px;
        }

        .btn {
            padding: 5px 16px;
            border: 1px solid #d0d7de;
            border-radius: 6px;
            background: white;
            cursor: pointer;
            font-size: 14px;
            text-decoration: none;
            color: #24292f;
        }

        .btn:hover {
            background: #f3f4f6;
        }

        .btn-primary {
            background: #2da44e;
            color: white;
            border-color: #2da44e;
        }

        .btn-primary:hover {
            background: #2c974b;
        }

        .file-list {
            border-collapse: collapse;
            width: 100%;
        }

        .file-list th,
        .file-list td {
            padding: 8px 16px;
            text-align: left;
            border-bottom: 1px solid #d0d7de;
        }

        .file-list th {
            background: #f6f8fa;
            font-weight: 600;
            font-size: 12px;
            text-transform: uppercase;
            color: #656d76;
        }

        .file-row:hover {
            background: #f6f8fa;
        }

        .file-icon {
            width: 16px;
            height: 16px;
            margin-right: 8px;
            vertical-align: middle;
        }

        .file-name {
            display: flex;
            align-items: center;
            font-weight: 600;
        }

        .commit-message {
            color: #656d76;
            max-width: 300px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .sidebar {
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        .sidebar-section {
            background: white;
            border: 1px solid #d0d7de;
            border-radius: 6px;
            padding: 16px;
        }

        .sidebar-title {
            font-weight: 600;
            margin-bottom: 12px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .contributor-item {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 4px 0;
        }

        .contributor-avatar {
            width: 20px;
            height: 20px;
            border-radius: 50%;
        }

        .contributor-name {
            font-size: 14px;
            font-weight: 500;
        }

        .contributor-commits {
            font-size: 12px;
            color: #656d76;
            margin-left: auto;
        }

        .loading {
            text-align: center;
            padding: 20px;
            color: #656d76;
        }

        .error {
            color: #d1242f;
            background: #fff8f8;
            border: 1px solid #f8d7da;
            border-radius: 6px;
            padding: 12px;
            margin: 10px 0;
        }

        .language-bar {
            height: 8px;
            border-radius: 4px;
            overflow: hidden;
            margin: 8px 0;
            background: #f6f8fa;
        }

        .language-segment {
            height: 100%;
            display: inline-block;
        }

        .language-list {
            font-size: 12px;
            margin-top: 8px;
        }

        .language-item {
            display: flex;
            align-items: center;
            gap: 6px;
            margin: 4px 0;
        }

        .language-color {
            width: 12px;
            height: 12px;
            border-radius: 50%;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1 class="repo-title" id="repoTitle">Repository</h1>
            <div class="repo-input">
                <input type="text" id="ownerInput" placeholder="Owner (e.g., salmabm)" value="salmabm">
                <input type="text" id="repoInput" placeholder="Repository name" value="">
                <button onclick="loadRepository()">Load Repository</button>
            </div>
        </div>

        <div class="main-content">
            <div class="file-section">
                <div class="file-header">
                    <div class="branch-selector">
                        <span>üìÅ</span>
                        <select id="branchSelect" onchange="loadFiles()">
                            <option value="">Select branch...</option>
                        </select>
                        <span id="fileCount"></span>
                    </div>
                    <div class="action-buttons">
                        <button class="btn" onclick="addFile()">Add file</button>
                        <button class="btn btn-primary" onclick="openCode()">Code</button>
                    </div>
                </div>

                <div id="fileListContainer">
                    <div class="loading">Select a repository to view files</div>
                </div>
            </div>

            <div class="sidebar">
                <div class="sidebar-section">
                    <div class="sidebar-title">
                        üë• Contributors
                        <span id="contributorCount" style="background: #d1242f; color: white; border-radius: 10px; padding: 2px 6px; font-size: 12px;">0</span>
                    </div>
                    <div id="contributorsList">
                        <div class="loading">Loading contributors...</div>
                    </div>
                </div>

                <div class="sidebar-section">
                    <div class="sidebar-title">üíª Languages</div>
                    <div id="languagesList">
                        <div class="loading">Loading languages...</div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        let currentOwner = '';
        let currentRepo = '';
        let currentBranch = 'main';

        function loadRepository() {
            currentOwner = document.getElementById('ownerInput').value.trim();
            currentRepo = document.getElementById('repoInput').value.trim();

            if (!currentOwner || !currentRepo) {
                alert('Please enter both owner and repository name');
                return;
            }

            document.getElementById('repoTitle').textContent = `${currentOwner}/${currentRepo}`;

            // Load all repository data
            loadBranches();
            loadContributors();
            loadLanguages();
        }

        function loadBranches() {
            fetch(`/api/repos/${currentOwner}/${currentRepo}/branches`)
                .then(response => response.json())
                .then(branches => {
                    const branchSelect = document.getElementById('branchSelect');
                    branchSelect.innerHTML = '';

                    branches.forEach(branch => {
                        const option = document.createElement('option');
                        option.value = branch;
                        option.textContent = branch;
                        if (branch === 'main' || branch === 'master') {
                            option.selected = true;
                            currentBranch = branch;
                        }
                        branchSelect.appendChild(option);
                    });

                    // Load files for default branch
                    loadFiles();
                })
                .catch(error => {
                    console.error('Error loading branches:', error);
                    document.getElementById('fileListContainer').innerHTML =
                        `<div class="error">Error loading branches: ${error.message}</div>`;
                });
        }

        function loadFiles() {
            const branchSelect = document.getElementById('branchSelect');
            currentBranch = branchSelect.value || 'main';

            document.getElementById('fileListContainer').innerHTML = '<div class="loading">Loading files...</div>';

            // Use the new GitHub API endpoint for real commit data
            fetch(`/api/stats/${currentOwner}/${currentRepo}/files`)
                .then(response => response.json())
                .then(files => {
                    displayFiles(files);
                })
                .catch(error => {
                    console.error('Error loading files:', error);
                    document.getElementById('fileListContainer').innerHTML =
                        `<div class="error">Error loading files: ${error.message}</div>`;
                });
        }

        function displayFiles(files) {
            if (!files || files.length === 0) {
                document.getElementById('fileListContainer').innerHTML =
                    '<div class="loading">No files found in this repository</div>';
                return;
            }

            document.getElementById('fileCount').textContent = `${files.length} files`;

            const table = document.createElement('table');
            table.className = 'file-list';

            // Table header
            table.innerHTML = `
                <thead>
                    <tr>
                        <th>Name</th>
                        <th>Commit Message</th>
                        <th>Committer</th>
                        <th>Updated</th>
                    </tr>
                </thead>
                <tbody id="fileTableBody">
                </tbody>
            `;

            const tbody = table.querySelector('#fileTableBody');

            files.forEach(file => {
                const row = document.createElement('tr');
                row.className = 'file-row';

                const fileIcon = file.type === 'dir' ? 'üìÅ' : getFileIcon(file.name);
                const commitMessage = file.commit_message || 'No commit message';
                const committerName = file.committer_login || file.author_name || 'Unknown';
                const commitDate = file.commit_date ? formatDate(file.commit_date) : 'Unknown date';

                row.innerHTML = `
                    <td>
                        <div class="file-name">
                            <span class="file-icon">${fileIcon}</span>
                            ${file.name}
                        </div>
                    </td>
                    <td>
                        <div class="commit-message" title="${commitMessage}">
                            ${commitMessage}
                        </div>
                    </td>
                    <td>${committerName}</td>
                    <td>${commitDate}</td>
                `;

                tbody.appendChild(row);
            });

            document.getElementById('fileListContainer').innerHTML = '';
            document.getElementById('fileListContainer').appendChild(table);
        }

        function loadContributors() {
            document.getElementById('contributorsList').innerHTML = '<div class="loading">Loading contributors...</div>';

            fetch(`/api/stats/${currentOwner}/${currentRepo}/sidebar/contributors`)
                .then(response => response.json())
                .then(data => {
                    displayContributors(data);
                })
                .catch(error => {
                    console.error('Error loading contributors:', error);
                    document.getElementById('contributorsList').innerHTML =
                        `<div class="error">Error loading contributors</div>`;
                });
        }

        function displayContributors(data) {
            const contributors = data.contributors || [];
            document.getElementById('contributorCount').textContent = contributors.length;

            if (contributors.length === 0) {
                document.getElementById('contributorsList').innerHTML =
                    '<div style="color: #656d76; font-size: 14px;">No contributors found</div>';
                return;
            }

            const contributorsList = document.getElementById('contributorsList');
            contributorsList.innerHTML = '';

            contributors.slice(0, 10).forEach(contributor => {
                const item = document.createElement('div');
                item.className = 'contributor-item';

                const avatar = contributor.avatar_url || 'https://github.com/identicons/default.png';
                const name = contributor.login || contributor.name || 'Unknown';
                const commits = contributor.contributions || contributor.total_commits || 0;

                item.innerHTML = `
                    <img src="${avatar}" alt="${name}" class="contributor-avatar">
                    <span class="contributor-name">${name}</span>
                    <span class="contributor-commits">${commits} commits</span>
                `;

                contributorsList.appendChild(item);
            });
        }

        function loadLanguages() {
            document.getElementById('languagesList').innerHTML = '<div class="loading">Loading languages...</div>';

            fetch(`/api/stats/${currentOwner}/${currentRepo}/sidebar/languages`)
                .then(response => response.json())
                .then(languages => {
                    displayLanguages(languages);
                })
                .catch(error => {
                    console.error('Error loading languages:', error);
                    document.getElementById('languagesList').innerHTML =
                        `<div class="error">Error loading languages</div>`;
                });
        }

        function displayLanguages(languages) {
            if (!languages || languages.length === 0) {
                document.getElementById('languagesList').innerHTML =
                    '<div style="color: #656d76; font-size: 14px;">No languages detected</div>';
                return;
            }

            const languagesList = document.getElementById('languagesList');

            // Create language bar
            const languageBar = document.createElement('div');
            languageBar.className = 'language-bar';

            languages.forEach(lang => {
                const segment = document.createElement('div');
                segment.className = 'language-segment';
                segment.style.width = `${lang.percentage}%`;
                segment.style.backgroundColor = getLanguageColor(lang.name);
                segment.title = `${lang.name}: ${lang.percentage}%`;
                languageBar.appendChild(segment);
            });

            // Create language list
            const languageList = document.createElement('div');
            languageList.className = 'language-list';

            languages.slice(0, 5).forEach(lang => {
                const item = document.createElement('div');
                item.className = 'language-item';
                item.innerHTML = `
                    <div class="language-color" style="background-color: ${getLanguageColor(lang.name)}"></div>
                    <span>${lang.name}</span>
                    <span style="margin-left: auto; color: #656d76;">${lang.percentage}%</span>
                `;
                languageList.appendChild(item);
            });

            languagesList.innerHTML = '';
            languagesList.appendChild(languageBar);
            languagesList.appendChild(languageList);
        }

        function getFileIcon(filename) {
            const ext = filename.split('.').pop().toLowerCase();
            const icons = {
                'js': 'üìÑ', 'ts': 'üìÑ', 'jsx': 'üìÑ', 'tsx': 'üìÑ',
                'html': 'üåê', 'css': 'üé®', 'scss': 'üé®', 'sass': 'üé®',
                'py': 'üêç', 'java': '‚òï', 'cpp': '‚öôÔ∏è', 'c': '‚öôÔ∏è',
                'md': 'üìù', 'txt': 'üìÑ', 'json': 'üìã', 'xml': 'üìã',
                'png': 'üñºÔ∏è', 'jpg': 'üñºÔ∏è', 'jpeg': 'üñºÔ∏è', 'gif': 'üñºÔ∏è',
                'pdf': 'üìï', 'zip': 'üì¶', 'tar': 'üì¶', 'gz': 'üì¶'
            };
            return icons[ext] || 'üìÑ';
        }

        function getLanguageColor(language) {
            const colors = {
                'JavaScript': '#f1e05a', 'TypeScript': '#2b7489', 'Python': '#3572A5',
                'Java': '#b07219', 'C++': '#f34b7d', 'C': '#555555', 'C#': '#239120',
                'PHP': '#4F5D95', 'Ruby': '#701516', 'Go': '#00ADD8', 'Rust': '#dea584',
                'HTML': '#e34c26', 'CSS': '#563d7c', 'Shell': '#89e051', 'Dockerfile': '#384d54'
            };
            return colors[language] || '#586069';
        }

        function formatDate(dateString) {
            if (!dateString || dateString === 'Unknown date') return 'Unknown date';
            try {
                const date = new Date(dateString);
                const now = new Date();
                const diffTime = Math.abs(now - date);
                const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));

                if (diffDays === 1) return 'yesterday';
                if (diffDays < 7) return `${diffDays} days ago`;
                if (diffDays < 30) return `${Math.ceil(diffDays / 7)} weeks ago`;
                if (diffDays < 365) return `${Math.ceil(diffDays / 30)} months ago`;
                return `${Math.ceil(diffDays / 365)} years ago`;
            } catch (e) {
                return dateString;
            }
        }

        function addFile() {
            alert('Add file functionality would be implemented here');
        }

        function openCode() {
            window.open(`https://github.com/${currentOwner}/${currentRepo}`, '_blank');
        }

        // Load default repository on page load
        window.onload = function() {
            // You can set default values here
            // loadRepository();
        };
    </script>
</body>
</html>
